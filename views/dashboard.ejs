<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Boxicons -->
	<link href='https://unpkg.com/boxicons@2.0.9/css/boxicons.min.css' rel='stylesheet'>
	<!-- CSS -->
	<link rel="stylesheet" href="/admin.css">
	<!-- FileSaver.js for download functionality -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

	<title>Twitter Analytics Dashboard</title>
</head>
<body>

	<!-- SIDEBAR -->
	<section id="sidebar">
		<a href="#" class="brand">
			<i class='bx bxl-twitter'></i>
			<span class="text">XBot</span>
		</a>
		<ul class="side-menu top">
			<li>
				<a href="#" id="homeBtn">
					<i class='bx bxs-home'></i>
					<span class="text">Home</span>
				</a>
			</li>
			<li id="relevantNavItem" class="sub-item" style="display: none;">
				<a href="#" id="relevantBtn">
					<i class='bx bxs-dashboard'></i>
					<span class="text">Relevant Tweets</span>
				</a>
			</li>
			<li id="topicAssociationNavItem" class="sub-item" style="display: none;">
				<a href="#" id="topicAssociationBtn">
					<i class='bx bxs-network-chart'></i>
					<span class="text">Topic Association</span>
				</a>
			</li>
			<li>
				<a href="#" id="topBtn">
					<i class='bx bxs-chat'></i>
					<span class="text">My Tweets</span>
				</a>
			</li>
			<li>
				<a href="#" id="engagersBtn">
					<i class='bx bxs-group'></i>
					<span class="text">Engagers</span>
				</a>
			</li>
			<li>
				<a href="#" id="followAccountsBtn" title="">
					<i class='bx bxs-user-plus'></i>
					<span class="text">Follow Accounts</span>
				</a>
			</li>
		</ul>
	</section>
	<!-- SIDEBAR -->

	<!-- CONTENT -->
	<section id="content">
		<!-- NAVBAR -->
		<nav>
			<i class='bx bx-menu'></i>
			
			<input type="checkbox" id="switch-mode" hidden>
			<label for="switch-mode" class="switch-mode"></label>
		</nav>
		<!-- NAVBAR -->
        
		<!-- MAIN -->
		<main id="twitterDashboard">
			<div class="head-title">
				<div class="left">
					<h1 id="resultsTitle">Twitter Analytics Dashboard</h1>
				</div>
			</div>
			
			<!-- Welcome Message -->
			<div id="welcomeMessage" class="welcome-container">
				<div class="welcome-content">
					<i class='bx bxs-smile welcome-icon'></i>
					<h2>Welcome to the Twitter Analytics Dashboard</h2>
					<div class="topic-selection">
						<label for="topicSelect">Select Topic:</label>
						<select id="topicSelect" onchange="setTopic()">
							<option value="" disabled selected>Choose a topic...</option>
						</select>
					</div>
					<div class="follower-filter" id="followerFilter" style="display: none;">
						<label for="followerCount">Minimum Follower Count:</label>
						<input type="number" id="followerCount" min="0" step="100" />
						<small>Filter results by minimum follower count</small>
					</div>
					<p id="welcomeText">Please select a topic to get started.</p>
					<div class="welcome-options" id="welcomeOptions" style="display: none;">
						<div class="welcome-option" data-action="relevant">
							<i class='bx bxs-dashboard'></i>
							<span>Relevant Tweets</span>
						</div>
						<div class="welcome-option" data-action="topic-association">
							<i class='bx bxs-network-chart'></i>
							<span>Topic Association</span>
						</div>
					</div>
				</div>
			</div>
			
			<!-- Status and Loading -->
			<div id="status" class="status-message" style="display:none"></div>

			<!-- Results Container -->
			<div id="resultsContainer" class="table-data" style="display:none">
				<div class="order">
					<div class="head">
						<h3 id="subTitle">Results</h3>
					</div>
					<div id="tweet-container"></div>
				</div>
			</div>
		</main>
		<!-- MAIN -->
	</section>
	<!-- CONTENT -->

	<script>
		// Twitter Analytics Functionality
		const statusDiv = document.getElementById('status');
		const container = document.getElementById('tweet-container');
		const resultsTitle = document.getElementById('resultsTitle');
		const subTitle = document.getElementById('subTitle');
		const welcomeMessage = document.getElementById('welcomeMessage');
		const resultsContainer = document.getElementById('resultsContainer');
		
		let selectedTopic = null;
		
		function getFollowerCount() {
			const followerCountInput = document.getElementById('followerCount');
			return followerCountInput.value ? parseInt(followerCountInput.value) : 1000;
		}
		
		async function setTopic() {
			const topicSelect = document.getElementById('topicSelect');
			const welcomeText = document.getElementById('welcomeText');
			const welcomeOptions = document.getElementById('welcomeOptions');
			const followerFilter = document.getElementById('followerFilter');
			const followerCountInput = document.getElementById('followerCount');
			const relevantNavItem = document.getElementById('relevantNavItem');
			const topicAssociationNavItem = document.getElementById('topicAssociationNavItem');
			
			selectedTopic = topicSelect.value;
			
			// Check if "Add Environment" was selected
			if (selectedTopic === 'add-environment') {
				showAddEnvironmentModal();
				// Reset dropdown to empty selection
				topicSelect.value = '';
				selectedTopic = null;
				return;
			}
			if (selectedTopic) {
				welcomeText.textContent = `Topic set to ${topicSelect.options[topicSelect.selectedIndex].text}. Set follower filter and choose an action below:`;
				welcomeOptions.style.display = 'flex';
				followerFilter.style.display = 'block';
				
				// Get default follower count from config for this topic
				try {
					const configResponse = await fetch('/get-topic-config', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
						},
						body: JSON.stringify({ topic: selectedTopic })
					});
					const configData = await configResponse.json();
					
					if (configData.success && configData.config.followersThreshold) {
						followerCountInput.value = configData.config.followersThreshold;
					}
				} catch (err) {
					console.log('Error getting topic config:', err);
					// Set a default value if config fetch fails
					followerCountInput.value = 1000;
				}
				
				// Show the topic-specific navigation items
				relevantNavItem.style.display = 'block';
				topicAssociationNavItem.style.display = 'block';
				
				// Enable Follow Accounts button
				updateFollowAccountsButton(true);
				
				// Send topic to server with error handling
				try {
					const response = await fetch('/set-topic', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
						},
						body: JSON.stringify({ topic: selectedTopic })
					});
					
					const result = await response.json();
					
					if (!result.success) {
						// Invalid topic - show error and reset
						alert(`❌ Invalid topic "${selectedTopic}": ${result.message}\n\nPlease choose from the available topics: ethereum, basketball`);
						
						// Reset the dropdown
						topicSelect.value = '';
						selectedTopic = null;
						
						// Hide all topic-dependent elements
						welcomeText.textContent = 'Please select a topic to get started.';
						welcomeOptions.style.display = 'none';
						followerFilter.style.display = 'none';
						relevantNavItem.style.display = 'none';
						topicAssociationNavItem.style.display = 'none';
						updateFollowAccountsButton(false);
						
						return;
					}
				} catch (err) {
					console.log('Error setting topic:', err);
					alert('❌ Error setting topic. Please try again.');
					
					// Reset on error
					topicSelect.value = '';
					selectedTopic = null;
					welcomeText.textContent = 'Please select a topic to get started.';
					welcomeOptions.style.display = 'none';
					followerFilter.style.display = 'none';
					relevantNavItem.style.display = 'none';
					topicAssociationNavItem.style.display = 'none';
					updateFollowAccountsButton(false);
					
					return;
				}
			} else {
				welcomeText.textContent = 'Please select a topic to get started.';
				welcomeOptions.style.display = 'none';
				followerFilter.style.display = 'none';
				
				// Hide the topic-specific navigation items
				relevantNavItem.style.display = 'none';
				topicAssociationNavItem.style.display = 'none';
				
				// Disable Follow Accounts button
				updateFollowAccountsButton(false);
			}
		}

		// Function to update Follow Accounts button state
		function updateFollowAccountsButton(enabled) {
			const followBtn = document.getElementById('followAccountsBtn');
			console.log('Updating follow button:', enabled, followBtn);
			if (enabled) {
				followBtn.classList.remove('disabled');
				followBtn.title = '';
				followBtn.style.opacity = '1';
				followBtn.style.cursor = 'pointer';
			} else {
				followBtn.classList.add('disabled');
				followBtn.title = 'Set topic first';
				followBtn.style.opacity = '0.5';
				followBtn.style.cursor = 'not-allowed';
			}
			console.log('Button title set to:', followBtn.title);
		}

		const switchMode = document.getElementById('switch-mode');

		switchMode.addEventListener('change', function () {
			if(this.checked) {
				document.body.classList.add('dark');
			} else {
				document.body.classList.remove('dark');
			}
		})

		// Automatically select Home on page load and check for existing topic
		window.addEventListener('DOMContentLoaded', async () => {
			activateSidebarItem('home');
			
			// Load available topics from config
			await loadAvailableTopics();
			// Check if a topic is already set in the session
			try {
				const response = await fetch('/get-current-topic');
				const data = await response.json();
				
				console.log('Topic check response:', data);
				
				if (data.success && data.topic) {
					// Set the dropdown to the current topic
					const topicSelect = document.getElementById('topicSelect');
					topicSelect.value = data.topic;
					selectedTopic = data.topic;
					
					console.log('Setting topic to:', data.topic);
					
					// Trigger the setTopic function to show all UI elements
					await setTopic();
				} else {
					// No topic set, disable Follow Accounts button
					updateFollowAccountsButton(false);
				}
			} catch (err) {
				console.log('No existing topic found or error checking topic:', err);
				// No topic set, disable Follow Accounts button
				updateFollowAccountsButton(false);
			}
		});

		// Function to load available topics from config
		async function loadAvailableTopics() {
			try {
				const response = await fetch('/get-available-topics');
				const data = await response.json();
				
				if (data.success && data.topics) {
					const topicSelect = document.getElementById('topicSelect');
					
					// Clear existing options except the first one
					topicSelect.innerHTML = '<option value="" disabled selected>Choose a topic...</option>';
					
					// Add topics from config
					data.topics.forEach(topic => {
						const option = document.createElement('option');
						option.value = topic.key;
						option.textContent = topic.name;
						topicSelect.appendChild(option);
					});
					
					// Add "Add Environment" option
					const addEnvOption = document.createElement('option');
					addEnvOption.value = 'add-environment';
					addEnvOption.textContent = '+ Add Environment';
					addEnvOption.style.fontWeight = 'bold';
					addEnvOption.style.color = '#007bff';
					topicSelect.appendChild(addEnvOption);
					
					console.log('Loaded topics:', data.topics);
				} else {
					console.error('Failed to load topics:', data.message);
				}
			} catch (err) {
				console.error('Error loading topics:', err);
			}
		}
		// Function to activate sidebar item
		function activateSidebarItem(action) {
			// Remove active class from all sidebar items
			document.querySelectorAll('#sidebar .side-menu.top li').forEach(li => {
				li.classList.remove('active');
			});
			
			// Add active class to the corresponding sidebar item
			switch(action) {
				case 'home':
					document.querySelector('#sidebar .side-menu.top li:first-child').classList.add('active');
					break;
				case 'relevant':
					document.getElementById('relevantNavItem').classList.add('active');
					break;
				case 'topic-association':
					document.getElementById('topicAssociationNavItem').classList.add('active');
					break;
				case 'top':
					document.querySelector('#sidebar .side-menu.top li:nth-child(4)').classList.add('active');
					break;
				case 'engagers':
					document.querySelector('#sidebar .side-menu.top li:nth-child(5)').classList.add('active');
					break;
				case 'follow':
					document.querySelector('#sidebar .side-menu.top li:nth-child(6)').classList.add('active');
					break;
			}
		}

		// Sidebar button event listeners
		document.getElementById('homeBtn').addEventListener('click', () => {
			activateSidebarItem('home');
			showWelcome();
			resultsTitle.textContent = 'Twitter Analytics Dashboard';
			
			// Show/hide topic-specific elements based on current topic selection
			const relevantNavItem = document.getElementById('relevantNavItem');
			const topicAssociationNavItem = document.getElementById('topicAssociationNavItem');
			const followerFilter = document.getElementById('followerFilter');
			const welcomeOptions = document.getElementById('welcomeOptions');
			const topicSelect = document.getElementById('topicSelect');
			
			if (topicSelect.value) {
				relevantNavItem.style.display = 'block';
				topicAssociationNavItem.style.display = 'block';
				followerFilter.style.display = 'block';
				welcomeOptions.style.display = 'flex';
			} else {
				relevantNavItem.style.display = 'none';
				topicAssociationNavItem.style.display = 'none';
				followerFilter.style.display = 'none';
				welcomeOptions.style.display = 'none';
			}
		});

		document.getElementById('relevantBtn').addEventListener('click', () => {
			const topicSelect = document.getElementById('topicSelect');
			if (!selectedTopic && !topicSelect.value) {
				showTopicRequiredMessage('Relevant Tweets');
				return;
			}
			// Update selectedTopic if it's not set but dropdown has value
			if (!selectedTopic && topicSelect.value) {
				selectedTopic = topicSelect.value;
			}
			activateSidebarItem('relevant');
			showResults();
			loadMonitor();
			resultsTitle.textContent = 'Relevant Tweets Monitor';
			subTitle.textContent = '';
		});

		document.getElementById('topBtn').addEventListener('click', () => {
			// My Tweets doesn't require a topic
			activateSidebarItem('top');
			showResults();
			loadTweets('/my-top');
			resultsTitle.textContent = 'My Top Tweets';
			subTitle.textContent = 'Tweets';
		});

		document.getElementById('engagersBtn').addEventListener('click', () => {
			// Latest Engagers doesn't require a topic
			activateSidebarItem('engagers');
			showResults();
			loadEngagers();
			resultsTitle.textContent = 'Latest Engagers';
			subTitle.textContent = 'Users';
		});

		document.getElementById('followAccountsBtn').addEventListener('click', (e) => {
			// Check if button is disabled
			if (e.target.closest('#followAccountsBtn').classList.contains('disabled')) {
				// Button is disabled, do nothing (tooltip will show)
				return;
			}
			
			// Follow Accounts requires a topic to be set
			const topicSelect = document.getElementById('topicSelect');
			if (!selectedTopic && !topicSelect.value) {
				showTopicRequiredMessage('Follow Accounts');
				return;
			}
			activateSidebarItem('follow');
			showResults();
			followAccounts();
			resultsTitle.textContent = 'Follow Accounts';
			subTitle.textContent = 'Users';
		});

		document.getElementById('topicAssociationBtn').addEventListener('click', () => {
			const topicSelect = document.getElementById('topicSelect');
			if (!selectedTopic && !topicSelect.value) {
				showTopicRequiredMessage('Topic Association');
				return;
			}
			// Update selectedTopic if it's not set but dropdown has value
			if (!selectedTopic && topicSelect.value) {
				selectedTopic = topicSelect.value;
			}
			activateSidebarItem('topic-association');
			showResults();
			loadTopicAssociation();
			resultsTitle.textContent = 'Topic Association';
			subTitle.textContent = 'Generate Reply Suggestions';
		});


		// Welcome screen button event listeners
		document.querySelectorAll('.welcome-option').forEach(option => {
			option.addEventListener('click', () => {
				const action = option.getAttribute('data-action');
				activateSidebarItem(action);
				
				switch(action) {
					case 'relevant':
						showResults();
						loadMonitor();
						resultsTitle.textContent = 'Relevant Tweets Monitor';
						subTitle.textContent = '';
						break;
					case 'top':
						showResults();
						loadTweets('/my-top');
						resultsTitle.textContent = 'My Top Tweets';
						subTitle.textContent = 'Tweets';
						break;
					case 'engagers':
						showResults();
						loadEngagers();
						resultsTitle.textContent = 'Latest Engagers';
						subTitle.textContent = 'Users';
						break;
					case 'follow':
						showResults();
						followAccounts();
						resultsTitle.textContent = 'Follow Accounts';
						subTitle.textContent = 'Users';
						break;
					case 'topic-association':
						showResults();
						loadTopicAssociation();
						resultsTitle.textContent = 'Topic Association';
						subTitle.textContent = 'Generate Reply Suggestions';
						break;
				}
			});
		});

		function showResults() {
			welcomeMessage.style.display = 'none';
			resultsContainer.style.display = 'block';
		}

		function showWelcome() {
			welcomeMessage.style.display = 'flex';
			resultsContainer.style.display = 'none';
			statusDiv.style.display = 'none';
		}

		function showTopicRequiredMessage(featureName) {
			activateSidebarItem('home');
			showWelcome();
			resultsTitle.textContent = 'Topic Selection Required';
			
			// Highlight the topic selection
			const topicSelect = document.getElementById('topicSelect');
			const welcomeText = document.getElementById('welcomeText');
			
			welcomeText.textContent = `Please select a topic first to use ${featureName}.`;
			welcomeText.style.color = 'var(--red)';
			topicSelect.style.borderColor = 'var(--red)';
			
			// Reset styling after 3 seconds
			setTimeout(() => {
				welcomeText.style.color = '';
				topicSelect.style.borderColor = '';
				if (!selectedTopic) {
					welcomeText.textContent = 'Please select a topic to get started.';
				}
			}, 3000);
		}

		function clearResults() {
			container.innerHTML = '';
			statusDiv.style.display = 'none';
		}

		async function loadTweets(endpoint) {
			container.innerHTML = '';
			statusDiv.style.display = '';
			statusDiv.textContent = 'Loading . . . ';

			try {
				const r = await fetch(endpoint);
				const { success, message, tweets } = await r.json();
				statusDiv.textContent = message;
				statusDiv.className = 'status-message ' + (success ? 'status-success' : 'status-error');

				if (tweets.length === 0) {
					container.innerHTML = '<div class="no-tweets">No tweets found.</div>';
				} else {
					container.innerHTML = tweets.map(t => `
						<a href="${t.url}" target="_blank" class="tweet-url">
							<div class="tweet">
								<p class="tweet-text">${t.text}</p>
								<p class="engagements">💬 ${t.replies} 🔁 ${t.reposts} ❤️ ${t.likes}</p>
							</div>
						</a>
					`).join('');
				}
			} catch (e) {
				statusDiv.textContent = 'Error fetching tweets.';
				statusDiv.className = 'status-message status-error';
			} finally {
			}
		}

		async function loadEngagers() {
			container.innerHTML = '';
			statusDiv.style.display = '';
			statusDiv.textContent = 'Loading . . . ';

			try {
				const r = await fetch('/my-engagers');
				const { success, message, engagers } = await r.json();
				statusDiv.textContent = message;
				statusDiv.className = 'status-message ' + (success ? 'status-success' : 'status-error');

				if (!engagers.length) {
					container.innerHTML = '<div class="no-tweets">No engagers found.</div>';
				} else {
					container.innerHTML = engagers.map(e => `
						<a href="https://x.com/${e.handle}" target="_blank" class="tweet-url">
							<div class="tweet">
								<p class="tweet-text">@${e.handle}</p>
								<p class="engagements">👥 Followers: ${e.followers}</p>
							</div>
						</a>
					`).join('');
				}
			} catch (e) {
				statusDiv.textContent = 'Error fetching engagers.';
				statusDiv.className = 'status-message status-error';
			} finally {
			}
		}

		async function followAccounts() {
			// Show threshold selection UI instead of running immediately
			await showFollowAccountsThresholdUI();
		}

		async function showFollowAccountsThresholdUI() {
			container.innerHTML = '';
			statusDiv.style.display = 'none';

			try {
				// Get current topic's followAccountsThreshold from config
				const configResponse = await fetch('/get-topic-config', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({ topic: selectedTopic })
				});
				const configData = await configResponse.json();
				
				const defaultThreshold = configData.success && configData.config.followAccountsThreshold 
					? configData.config.followAccountsThreshold 
					: 5000;

				// Create threshold selection UI
				container.innerHTML = `
					<div class="follow-threshold-container">
						<div class="threshold-header">
							<h3>Follow Accounts Configuration</h3>
							<p>Configure the follower threshold for accounts to follow</p>
						</div>
						
						<div class="threshold-setting">
							<label for="followThresholdInput"><strong>Minimum Follower Count:</strong></label>
							<input type="number" id="followThresholdInput" value="${defaultThreshold}" min="0" step="100" />
							<p class="threshold-note">Default for ${selectedTopic}: ${defaultThreshold.toLocaleString()} followers</p>
						</div>
						
						<div class="threshold-actions">
							<button id="runFollowAccounts" class="action-btn primary">
								<i class='bx bxs-user-plus'></i>
								Follow Accounts
							</button>
							<button id="cancelFollowAccounts" class="action-btn secondary">
								Cancel
							</button>
						</div>
					</div>
				`;

				// Add event listeners
				document.getElementById('runFollowAccounts').addEventListener('click', () => {
					const threshold = document.getElementById('followThresholdInput').value;
					executeFollowAccounts(parseInt(threshold));
				});

				document.getElementById('cancelFollowAccounts').addEventListener('click', () => {
					container.innerHTML = '';
					statusDiv.style.display = 'none';
				});

			} catch (error) {
				statusDiv.style.display = '';
				statusDiv.textContent = 'Error loading follow accounts configuration.';
				statusDiv.className = 'status-message status-error';
			}
		}

		async function executeFollowAccounts(threshold) {
			container.innerHTML = '';
			statusDiv.style.display = '';
			statusDiv.textContent = `Following accounts with ${threshold.toLocaleString()}+ followers, please wait...`;
			statusDiv.className = 'status-message';

			try {
				// Send threshold to server
				const response = await fetch('/follow', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({ threshold: threshold })
				});
				const data = await response.json();

				if (data.success) {
					if (data.followed.length > 0) {
						statusDiv.textContent = `Followed ${data.followed.length} accounts! Row added to spreadsheet.`;
						statusDiv.className = 'status-message status-success';

						// Display the accounts visually
						container.innerHTML = data.followed.map(acc => `
							<a href="${acc.profileUrl}" target="_blank" class="tweet-url">
								<div class="tweet">
									<p class="tweet-text">@${acc.handle}</p>
									<p class="engagements">👥 Followers: ${acc.followers.toLocaleString()}</p>
								</div>
							</a>
						`).join('');

						// Optionally add download link if backend returns file URL
						if (data.fileUrl) {
							const downloadLink = document.createElement('a');
							downloadLink.href = data.fileUrl;
							downloadLink.textContent = '📥 Download Spreadsheet';
							downloadLink.className = 'download-link';
							downloadLink.target = '_blank';
							container.appendChild(downloadLink);
						}
					} else {
						statusDiv.textContent = 'No accounts were followed.';
						statusDiv.className = 'status-message status-error';
						container.innerHTML = '<div class="no-tweets">No accounts followed.</div>';
					}
				} else {
					statusDiv.textContent = 'Failed: ' + data.message;
					statusDiv.className = 'status-message status-error';
					container.innerHTML = '<div class="no-tweets">Could not follow accounts.</div>';
				}
			} catch (err) {
				statusDiv.textContent = 'Error: ' + err.message;
				statusDiv.className = 'status-message status-error';
				container.innerHTML = '<div class="no-tweets">Something went wrong.</div>';
			}
		}

		async function loadMonitor() {
			container.innerHTML = '';
			statusDiv.style.display = '';
			statusDiv.textContent = 'Loading monitor status...';

			try {
				// Get current monitoring status
				const statusResponse = await fetch('/monitor/status');
				const statusData = await statusResponse.json();
				
				// Handle topic not selected error
				if (!statusData.success && statusData.needsTopicSelection) {
					showTopicRequiredMessage('Relevant Tweets Monitor');
					return;
				}

				// Create monitor interface
				container.innerHTML = `
					<div class="monitor-container">
						<div class="monitor-status">
							<h3>Relevant Tweets Monitor</h3>
							<div class="status-indicator ${statusData.isMonitoring ? 'active' : 'inactive'}">
								<i class='bx ${statusData.isMonitoring ? 'bxs-circle' : 'bxs-circle'}'></i>
								<span>${statusData.isMonitoring ? 'Active' : 'Inactive'}</span>
							</div>
							<p class="status-message">${statusData.message}</p>
						</div>
						
						<div class="monitor-controls">
							<button id="startMonitor" class="monitor-btn start" ${statusData.isMonitoring ? 'disabled' : ''}>
								<i class='bx bx-play'></i>
								Start Monitoring
							</button>
							<button id="stopMonitor" class="monitor-btn stop" ${!statusData.isMonitoring ? 'disabled' : ''}>
								<i class='bx bx-stop'></i>
								Stop Monitoring
							</button>
						</div>
						
						<div class="monitor-info">
							<h4>What this does:</h4>
							<ul>
								<li>📊 Monitors latest tweets spreadsheet for new rows</li>
								<li>👥 Checks follower count (must be >1000)</li>
								<li>🤖 Analyzes tweet content using AI (filters spam, bots, financial advice, etc.)</li>
								<li>✅ Adds relevant tweets to target spreadsheet</li>
								<li>⏰ Runs automatically every 5 minutes</li>
							</ul>
						</div>
					</div>
				`;

				// Add event listeners for monitor controls
				document.getElementById('startMonitor').addEventListener('click', startMonitoring);
				document.getElementById('stopMonitor').addEventListener('click', stopMonitoring);

				statusDiv.style.display = 'none';

			} catch (e) {
				statusDiv.textContent = 'Error loading monitor interface.';
				statusDiv.className = 'status-message status-error';
			}
		}

		async function startMonitoring() {
			try {
				// Immediately update UI for better UX
				const monitorStatus = document.querySelector('.monitor-status .status-indicator');
				const monitorStatusText = monitorStatus.querySelector('span');
				monitorStatus.classList.remove('inactive');
				monitorStatus.classList.add('active');
				monitorStatusText.textContent = 'Active';

				document.getElementById('startMonitor').disabled = true;
				document.getElementById('stopMonitor').disabled = false;

				statusDiv.textContent = 'Starting monitoring...';
				statusDiv.className = 'status-message status-success';
				statusDiv.style.display = '';

				const response = await fetch('/monitor/start', { method: 'POST' });
				const data = await response.json();

				statusDiv.textContent = data.message;
				statusDiv.className = 'status-message ' + (data.success ? 'status-success' : 'status-error');

				// Optionally, reload monitor interface after a short delay to sync with backend
				setTimeout(loadMonitor, 1000);

			} catch (e) {
				statusDiv.textContent = 'Error starting monitoring.';
				statusDiv.className = 'status-message status-error';
			}
		}

		async function stopMonitoring() {
			try {
				const response = await fetch('/monitor/stop', { method: 'POST' });
				const data = await response.json();
				
				if (data.success) {
					statusDiv.textContent = data.message;
					statusDiv.className = 'status-message status-success';
					// Reload monitor interface to update status
					loadMonitor();
				} else {
					statusDiv.textContent = data.message;
					statusDiv.className = 'status-message status-error';
				}
			} catch (e) {
				statusDiv.textContent = 'Error stopping monitoring.';
				statusDiv.className = 'status-message status-error';
			}
		}

		async function loadTopicAssociation() {
			container.innerHTML = '';
			statusDiv.style.display = 'none';
			
			// Check if topic is selected first
			const topicSelect = document.getElementById('topicSelect');
			if (!selectedTopic && !topicSelect.value) {
				showTopicRequiredMessage('Topic Association');
				return;
			}

			// Create Topic Association interface
			container.innerHTML = `
				<div class="topic-association-container">
					<div class="topic-form">
						<div class="form-section">
							<h3>Topic 1 (Broader Topic)</h3>
							<div class="input-group">
								<label for="topic1">Enter a broader topic or theme:</label>
								<input type="text" id="topic1" placeholder="e.g., Artificial Intelligence, DeFi, Climate Change" />
								<small style="color: var(--dark-grey); font-size: 12px; margin-top: 4px; display: block;">
									This topic will be used to generate connections and reply suggestions
								</small>
							</div>
						</div>
						
						<div class="form-section">
							<h3>Topic 2 (Tweets from <span id="configuredTopicName">Configured</span> Folder)</h3>
							<div class="input-group">
								<label for="availableSheets">Select a sheet from your <span id="configuredTopicName2">configured</span> folder:</label>
								<select id="availableSheets" disabled>
									<option value="">Loading available sheets...</option>
								</select>
								<button type="button" id="refreshSheetsBtn" style="margin-top: 8px; padding: 8px 16px; background: var(--blue); color: white; border: none; border-radius: 4px; cursor: pointer;">
									<i class='bx bx-refresh'></i> Refresh Sheets
								</button>
							</div>
							<div class="input-group">
								<label for="sheetRange">Row Range (optional):</label>
								<input type="text" id="sheetRange" placeholder="e.g., 1:10 (or leave empty for all data)" />
								<small style="color: var(--dark-grey); font-size: 12px; margin-top: 4px; display: block;">
									Just enter row numbers like "1:10" or "2:20". Columns A-E will be automatically included.
								</small>
							</div>
						</div>
						
						<div class="form-actions">
							<button id="drawConnectionsBtn" class="draw-connections-btn">
								<i class='bx bx-network-chart'></i>
								Draw Connections
							</button>
						</div>
					</div>
					
					<div id="suggestions-container" class="suggestions-container" style="display: none;">
						<h3>Generated Reply Suggestions</h3>
						<div id="suggestions-content"></div>
					</div>
				</div>
			`;

			// Add event listeners
			document.getElementById('drawConnectionsBtn').addEventListener('click', drawConnections);
			document.getElementById('refreshSheetsBtn').addEventListener('click', loadAvailableSheets);
			
			// Load sheets automatically when the interface loads
			loadAvailableSheets();
		}

		// Function to load available sheets from the configured topic folder
		async function loadAvailableSheets() {
			const availableSheets = document.getElementById('availableSheets');
			
			try {
				availableSheets.innerHTML = '<option value="">Loading sheets...</option>';
				
				const response = await fetch('/topic-association/sheets');
				const data = await response.json();
				
				if (data.success && data.sheets.length > 0) {
					// Update the UI to show the configured topic name
					document.getElementById('configuredTopicName').textContent = data.topicName;
					document.getElementById('configuredTopicName2').textContent = data.topicName;
					
					availableSheets.innerHTML = '<option value="">Select a sheet...</option>';
					data.sheets.forEach(sheet => {
						const option = document.createElement('option');
						option.value = sheet.id;
						option.textContent = sheet.name;
						availableSheets.appendChild(option);
					});
					availableSheets.disabled = false;
				} else {
					availableSheets.innerHTML = '<option value="">No sheets found in configured folder</option>';
					availableSheets.disabled = true;
				}
			} catch (error) {
				availableSheets.innerHTML = '<option value="">Error loading sheets</option>';
				availableSheets.disabled = true;
				console.error('Error loading sheets:', error);
			}
		}

		async function drawConnections() {
			const topic1 = document.getElementById('topic1').value.trim();
			const sheetId = document.getElementById('availableSheets').value;
			const sheetRange = document.getElementById('sheetRange').value.trim();

			if (!topic1) {
				statusDiv.textContent = 'Please enter a broader topic.';
				statusDiv.className = 'status-message status-error';
				statusDiv.style.display = '';
				return;
			}

			if (!sheetId) {
				statusDiv.textContent = 'Please select a sheet from the available options.';
				statusDiv.className = 'status-message status-error';
				statusDiv.style.display = '';
				return;
			}

			// Validate range format if provided
			if (sheetRange && !/^\d+:\d+$/.test(sheetRange) && !/^[A-Z]+\d+:[A-Z]+\d+$/.test(sheetRange) && !/^[A-Z]+:[A-Z]+$/.test(sheetRange)) {
				statusDiv.textContent = 'Invalid range format. Use formats like "1:10" or leave empty.';
				statusDiv.className = 'status-message status-error';
				statusDiv.style.display = '';
				return;
			}

			statusDiv.textContent = 'Generating connections and reply suggestions...';
			statusDiv.className = 'status-message';
			statusDiv.style.display = '';

			try {
				const response = await fetch('/topic-association', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({
						topic1,
						sheetId,
						sheetRange
					})
				});

				const data = await response.json();

				if (data.success) {
					statusDiv.textContent = data.message;
					statusDiv.className = 'status-message status-success';
					
					// Display suggestions
					displaySuggestions(data.suggestions);
				} else {
					statusDiv.textContent = data.message;
					statusDiv.className = 'status-message status-error';
					
					// Show "no connections" message instead of hiding the suggestions container
					displayNoConnections();
				}
			} catch (error) {
				statusDiv.textContent = 'Error generating connections: ' + error.message;
				statusDiv.className = 'status-message status-error';
			}
		}

		function displaySuggestions(suggestions) {
			const suggestionsContainer = document.getElementById('suggestions-container');
			const suggestionsContent = document.getElementById('suggestions-content');
			
			suggestionsContent.innerHTML = suggestions.map((suggestion, index) => `
				<div class="suggestion-item">
					<div class="original-tweet">
						<div class="tweet-header">
							<h4>Tweet ${index + 1}</h4>
							${suggestion.date && suggestion.date !== 'N/A' ? 
								`<div class="tweet-date">📅 ${suggestion.date}</div>` : 
								''}
							<div class="tweet-meta">
								<span class="tweet-handle">${suggestion.tweetHandle || '@unknown'}</span>
								${suggestion.tweetUrl && suggestion.tweetUrl !== 'N/A' ? 
									`<a href="${suggestion.tweetUrl}" target="_blank" class="tweet-link">🔗 View Tweet</a>` : 
									''}
								${suggestion.followerCount && suggestion.followerCount !== 'N/A' ? 
									`<span class="follower-count">👥 ${suggestion.followerCount}</span>` : 
									''}
							</div>
						</div>
						<p class="tweet-text">${suggestion.originalTweet}</p>
						<div class="connection-info">
							<strong>Connection:</strong> ${suggestion.connection}
						</div>
					</div>
					<div class="reply-suggestions">
						<h5>Reply Suggestions:</h5>
						<div class="replies-list">
							${suggestion.replies.map((reply, replyIndex) => `
								<div class="reply-item">
									<span class="reply-number">${replyIndex + 1}.</span>
									<span class="reply-text">${reply}</span>
									<button class="copy-reply-btn" data-reply="${reply}">
										<i class='bx bx-copy'></i>
									</button>
								</div>
							`).join('')}
						</div>
					</div>
				</div>
			`).join('');

			// Add copy functionality
			document.querySelectorAll('.copy-reply-btn').forEach(btn => {
				btn.addEventListener('click', () => {
					const reply = btn.getAttribute('data-reply');
					navigator.clipboard.writeText(reply).then(() => {
						btn.innerHTML = '<i class="bx bx-check"></i>';
						setTimeout(() => {
							btn.innerHTML = '<i class="bx bx-copy"></i>';
						}, 2000);
					});
				});
			});

			suggestionsContainer.style.display = 'block';
		}

		function displayNoConnections() {
			const suggestionsContainer = document.getElementById('suggestions-container');
			const suggestionsContent = document.getElementById('suggestions-content');
			
			suggestionsContent.innerHTML = `
				<div class="no-connections-message">
					<div class="no-connections-icon">🔗❌</div>
					<h4>No Connections Drawn</h4>
					<p>Claude CLI was unable to generate connections and reply suggestions.</p>
					<p>This could be due to:</p>
					<ul>
						<li>Invalid API key configuration</li>
						<li>Claude CLI not available</li>
						<li>Connection issues</li>
					</ul>
					<p>Please check the connection.log file for more details.</p>
				</div>
			`;
			
			suggestionsContainer.style.display = 'block';
		}

		// Add Environment Modal Functions
		function showAddEnvironmentModal() {
			// Create modal HTML
			const modal = document.createElement('div');
			modal.id = 'addEnvironmentModal';
			modal.className = 'modal-overlay';
			modal.innerHTML = `
				<div class="modal-content">
					<div class="modal-header">
						<h2>Add New Environment</h2>
						<button class="close-modal" onclick="closeAddEnvironmentModal()">&times;</button>
					</div>
					<div class="modal-body">
						<form id="addEnvironmentForm">
							<div class="form-group">
								<label for="envKey">Environment Key:</label>
								<input type="text" id="envKey" placeholder="e.g., bitcoin, stocks, crypto" required>
								<small>Lowercase, no spaces. Used internally as identifier.</small>
							</div>
							
							<div class="form-group">
								<label for="envName">Display Name:</label>
								<input type="text" id="envName" placeholder="e.g., Bitcoin, Stock Market, Cryptocurrency" required>
								<small>Human-readable name shown in the dropdown.</small>
							</div>
							
							<div class="form-group">
								<label for="searchQuery">Twitter Search Query:</label>
								<input type="text" id="searchQuery" placeholder="e.g., bitcoin -scam -giveaway -pump -dump" required>
								<small>Twitter search terms with filters to exclude spam.</small>
							</div>
							
							<div class="form-group">
								<label for="followersThreshold">Followers Threshold:</label>
								<input type="number" id="followersThreshold" value="2000" min="0" step="100" required>
								<small>Minimum follower count for analysis.</small>
							</div>
							
							<div class="form-group">
								<label for="followAccountsThreshold">Follow Accounts Threshold:</label>
								<input type="number" id="followAccountsThreshold" value="5000" min="0" step="100" required>
								<small>Minimum follower count to follow accounts.</small>
							</div>
							
							
							<div class="chrome-detection" id="chromeDetection" style="display: none;">
								<h4>Chrome Instance Selection</h4>
								<div id="chromeInstances"></div>
							</div>
							
							<div class="automation-progress" id="automationProgress" style="display: none;">
								<h4>Automation Progress</h4>
								<div class="progress-steps">
									<div class="progress-step" id="step-chrome">
										<i class='bx bx-loader bx-spin'></i>
										<span>Authenticating with APIs...</span>
									</div>
									<div class="progress-step" id="step-folder">
										<i class='bx bx-loader bx-spin'></i>
										<span>Creating Google Drive folder...</span>
									</div>
									<div class="progress-step" id="step-sheets">
										<i class='bx bx-loader bx-spin'></i>
										<span>Creating Google Sheets...</span>
									</div>
									<div class="progress-step" id="step-discord">
										<i class='bx bx-loader bx-spin'></i>
										<span>Creating Discord channel via API...</span>
									</div>
									<div class="progress-step" id="step-config">
										<i class='bx bx-loader bx-spin'></i>
										<span>Updating configuration...</span>
									</div>
								</div>
							</div>
							
							<div class="ifttt-instructions" id="iftttInstructions" style="display: none;">
								<h4>Manual Setup Required</h4>
								<div class="manual-steps" id="manualSheetSteps" style="display: none;">
									<div class="manual-step">
										<h5>📊 Google Sheets Creation</h5>
										<p><strong>A Chrome window opened to your folder. Please create these 2 sheets:</strong></p>
										<ol>
											<li><strong>Relevant Tweets</strong> - Add headers: Date, Username, Tweet, URL, Followers</li>
											<li><strong><span id="followReportSheetName"></span> Follow Report</strong> - Add headers: Date, Username, Profile URL, Followers, Following, Status</li>
										</ol>
									</div>
								</div>
								<p>IFTTT applets cannot be created automatically. Please create these manually:</p>
								<div class="ifttt-steps">
									<div class="ifttt-step">
										<h5>1. New Tweets Applet</h5>
										<p><strong>Trigger:</strong> Twitter - New tweets by search</p>
										<p><strong>Search term:</strong> <span id="iftttSearchQuery"></span></p>
										<p><strong>Action:</strong> Google Sheets - Add row to spreadsheet</p>
										<p><strong>Spreadsheet:</strong> <span id="iftttSheetName"></span></p>
									</div>
									<div class="ifttt-step">
										<h5>2. Relevant Tweets to Discord</h5>
										<p><strong>Trigger:</strong> Google Sheets - New row added</p>
										<p><strong>Spreadsheet:</strong> Relevant Tweets</p>
										<p><strong>Action:</strong> Discord - Post message to channel</p>
										<p><strong>Channel:</strong> <span id="iftttDiscordChannel"></span></p>
									</div>
								</div>
							</div>
						</form>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn-secondary" onclick="closeAddEnvironmentModal()">Cancel</button>
						<button type="button" class="btn-primary" onclick="startEnvironmentCreation()">Create Environment</button>
					</div>
				</div>
			`;
			
			document.body.appendChild(modal);
			
			// Add modal-open class to sidebar to disable it
			document.getElementById('sidebar').classList.add('modal-open');
			
			// Add modal styles
			if (!document.getElementById('modalStyles')) {
				const styles = document.createElement('style');
				styles.id = 'modalStyles';
				styles.textContent = `
					.modal-overlay {
						position: fixed;
						top: 0;
						left: 0;
						width: 100%;
						height: 100%;
						background: rgba(0, 0, 0, 0.7);
						display: flex;
						justify-content: center;
						align-items: center;
						z-index: 1000;
					}
					
					.modal-overlay::before {
						content: '';
						position: absolute;
						top: 0;
						left: 0;
						width: 100%;
						height: 100%;
						background: rgba(0, 0, 0, 0.5);
						z-index: -1;
					}
					
					#sidebar.modal-open {
						pointer-events: none;
						opacity: 0.3;
						z-index: 1;
					}
					
					.modal-content {
						background: var(--light);
						border-radius: 8px;
						max-width: 600px;
						width: 90%;
						max-height: 90vh;
						overflow-y: auto;
						box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
					}
					
					.modal-header {
						padding: 20px;
						border-bottom: 1px solid var(--grey);
						display: flex;
						justify-content: space-between;
						align-items: center;
					}
					
					.modal-header h2 {
						margin: 0;
						color: var(--dark);
					}
					
					.close-modal {
						background: none;
						border: none;
						font-size: 24px;
						cursor: pointer;
						color: var(--dark-grey);
						padding: 0;
						width: 30px;
						height: 30px;
						display: flex;
						align-items: center;
						justify-content: center;
					}
					
					.close-modal:hover {
						color: var(--red);
					}
					
					.modal-body {
						padding: 20px;
					}
					
					.form-group {
						margin-bottom: 20px;
					}
					
					.form-group label {
						display: block;
						margin-bottom: 5px;
						font-weight: bold;
						color: var(--dark);
					}
					
					.form-group input, .form-group select {
						width: 100%;
						padding: 10px;
						border: 1px solid var(--grey);
						border-radius: 4px;
						font-size: 14px;
					}
					
					.form-group small {
						display: block;
						margin-top: 5px;
						color: var(--dark-grey);
						font-size: 12px;
					}
					
					.modal-footer {
						padding: 20px;
						border-top: 1px solid var(--grey);
						display: flex;
						justify-content: flex-end;
						gap: 10px;
					}
					
					.btn-primary, .btn-secondary {
						padding: 10px 20px;
						border: none;
						border-radius: 4px;
						cursor: pointer;
						font-size: 14px;
					}
					
					.btn-primary {
						background: var(--blue);
						color: white;
					}
					
					.btn-primary:hover {
						background: #0056b3;
						color: white;
					}
					
					.btn-secondary {
						background: var(--grey);
						color: var(--dark);
					}
					
					.btn-secondary:hover {
						background: var(--dark-grey);
						color: white;
					}
					
					.chrome-detection {
						margin: 20px 0;
						padding: 15px;
						background: var(--light-grey);
						border-radius: 4px;
					}
					
					.chrome-instance {
						padding: 10px;
						margin: 5px 0;
						border: 1px solid var(--grey);
						border-radius: 4px;
						cursor: pointer;
					}
					
					.chrome-instance:hover {
						background: var(--blue);
						color: white;
					}
					
					.environment-success {
						text-align: center;
					}
					
					.success-header {
						margin-bottom: 30px;
					}
					
					.success-icon {
						font-size: 48px;
						color: #28a745;
						margin-bottom: 15px;
					}
					
					.success-header h3 {
						color: #28a745;
						margin-bottom: 15px;
					}
					
					.folder-info {
						background: #f8f9fa;
						padding: 15px;
						border-radius: 8px;
						border-left: 4px solid #28a745;
					}
					
					.url-copy-section {
						display: flex;
						gap: 10px;
						margin: 10px 0;
						align-items: center;
					}
					
					.url-input {
						flex: 1;
						padding: 8px 12px;
						border: 1px solid #ddd;
						border-radius: 4px;
						font-size: 14px;
						background: #f8f9fa;
					}
					
					.copy-btn {
						padding: 8px 16px;
						background: var(--blue);
						color: white;
						border: none;
						border-radius: 4px;
						cursor: pointer;
						font-size: 14px;
						display: flex;
						align-items: center;
						gap: 5px;
						transition: background 0.3s;
					}
					
					.copy-btn:hover {
						background: #0056b3;
					}
					
					.copy-btn i {
						font-size: 16px;
					}
					
					.manual-checklist {
						text-align: left;
						margin-top: 20px;
					}
					
					.checklist-section {
						margin-bottom: 25px;
						padding: 15px;
						background: #f8f9fa;
						border-radius: 8px;
						border-left: 4px solid var(--blue);
					}
					
					.checklist-section h5 {
						margin-bottom: 15px;
						color: var(--dark);
						font-size: 16px;
					}
					
					.checklist-item {
						display: flex;
						align-items: center;
						margin-bottom: 10px;
						padding: 8px;
						background: white;
						border-radius: 4px;
					}
					
					.checklist-item input[type="checkbox"] {
						margin-right: 10px;
						transform: scale(1.2);
					}
					
					.checklist-item label {
						cursor: pointer;
						flex-grow: 1;
						font-weight: normal;
					}
					
					.checklist-note {
						margin-top: 10px;
						padding: 8px;
						background: #e3f2fd;
						border-radius: 4px;
					}
					
					.checklist-note a {
						color: var(--blue);
						text-decoration: none;
					}
					
					.checklist-note a:hover {
						text-decoration: underline;
					}
					
					.warning-section {
						margin-top: 30px;
						padding: 15px;
						background: #fff3cd;
						border-left: 4px solid #ffc107;
						border-radius: 8px;
					}
					
					.warning-box {
						display: flex;
						align-items: center;
						margin-bottom: 15px;
						padding: 10px;
						background: #f8d7da;
						border-radius: 4px;
						border-left: 4px solid #dc3545;
					}
					
					.warning-icon {
						font-size: 24px;
						color: #dc3545;
						margin-right: 10px;
					}
					
					.warning-box p {
						margin: 0;
						color: #721c24;
						font-weight: bold;
					}
					
					.waiver-item {
						display: flex;
						align-items: center;
						padding: 12px;
						background: white;
						border-radius: 4px;
						border: 2px solid #ffc107;
					}
					
					.waiver-item input[type="checkbox"] {
						margin-right: 12px;
						transform: scale(1.3);
					}
					
					.waiver-item label {
						cursor: pointer;
						font-weight: bold;
						color: #856404;
					}
					
					.btn-primary:disabled {
						background: #6c757d !important;
						cursor: not-allowed !important;
						opacity: 0.6;
					}
					
					.btn-primary:disabled:hover {
						background: #6c757d !important;
					}
					
					.chrome-instance.selected {
						background: var(--blue);
						color: white;
					}
					
					.automation-progress {
						margin: 20px 0;
						padding: 15px;
						background: var(--light-grey);
						border-radius: 4px;
					}
					
					.progress-steps {
						display: flex;
						flex-direction: column;
						gap: 10px;
					}
					
					.progress-step {
						display: flex;
						align-items: center;
						gap: 10px;
						padding: 10px;
					}
					
					.progress-step.completed {
						color: var(--green);
					}
					
					.progress-step.error {
						color: var(--red);
					}
					
					.ifttt-instructions {
						margin: 20px 0;
						padding: 15px;
						background: var(--yellow);
						border-radius: 4px;
					}
					
					.ifttt-steps {
						margin-top: 15px;
					}
					
					.ifttt-step {
						margin-bottom: 15px;
						padding: 10px;
						background: white;
						border-radius: 4px;
					}
					
					.ifttt-step h5 {
						margin: 0 0 10px 0;
						color: var(--dark);
					}
					
					.ifttt-step p {
						margin: 5px 0;
						font-size: 14px;
					}
					
					.ifttt-step span {
						font-weight: bold;
						color: var(--blue);
					}
				`;
				document.head.appendChild(styles);
			}
		}
		
		function closeAddEnvironmentModal() {
			const modal = document.getElementById('addEnvironmentModal');
			if (modal) {
				modal.remove();
			}
			
			// Remove modal-open class from sidebar to re-enable it
			document.getElementById('sidebar').classList.remove('modal-open');
		}
		
		async function startEnvironmentCreation() {
			const form = document.getElementById('addEnvironmentForm');
			const formData = new FormData(form);
			
			// Validate form
			const envKey = document.getElementById('envKey').value.trim();
			const envName = document.getElementById('envName').value.trim();
			const searchQuery = document.getElementById('searchQuery').value.trim();
			const followersThreshold = document.getElementById('followersThreshold').value;
			const followAccountsThreshold = document.getElementById('followAccountsThreshold').value;
			const discordChannelName = envKey; // Use environment key as Discord channel name
			
			if (!envKey || !envName || !searchQuery || !followersThreshold || !followAccountsThreshold) {
				alert('Please fill in all required fields.');
				return;
			}
			
			// Validate environment key format
			if (!/^[a-z0-9_-]+$/.test(envKey)) {
				alert('Environment key must be lowercase letters, numbers, hyphens, or underscores only.');
				return;
			}
			
			// Hide form and show progress
			document.querySelector('.modal-body form').style.display = 'none';
			document.getElementById('automationProgress').style.display = 'block';
			document.querySelector('.btn-primary').style.display = 'none';
			
			try {
				// Call backend API to start automation
				const response = await fetch('/create-environment', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({
						envKey,
						envName,
						searchQuery,
						followersThreshold: parseInt(followersThreshold),
						followAccountsThreshold: parseInt(followAccountsThreshold),
						discordChannelName
					})
				});
				
				const result = await response.json();
				
				if (result.success) {
					// Hide progress and show manual checklist
					document.getElementById('automationProgress').style.display = 'none';
					
					// Show success message and manual checklist
					document.querySelector('.modal-body').innerHTML = `
						<div class="environment-success">
							<div class="success-header">
								<i class='bx bx-check-circle success-icon'></i>
								<h3>Environment Created Successfully!</h3>
								<div class="folder-info">
									<p>📁 Google Drive folder created: <strong>${result.envName}</strong></p>
									<div class="url-copy-section">
										<input type="text" id="folderUrl" value="${result.folderUrl}" readonly class="url-input">
										<button type="button" class="copy-btn" onclick="copyFolderUrl()">
											<i class='bx bx-copy'></i> Copy Link
										</button>
									</div>
									<small>💡 Copy the link above and open it manually in your Chrome with logged profile</small>
								</div>
							</div>
							
							<div class="manual-checklist">
								<h4>📋 Complete these manual steps:</h4>
								
								<div class="checklist-section">
									<h5>📊 GOOGLE SHEETS</h5>
									<div class="checklist-item">
										<input type="checkbox" id="sheet1" onchange="checkAllCompleted()" />
										<label for="sheet1">Create "Relevant Tweets" sheet</label>
									</div>
									<div class="checklist-item">
										<input type="checkbox" id="sheet2" onchange="checkAllCompleted()" />
										<label for="sheet2">Create "${result.envName} Follow Report" sheet</label>
									</div>
									<div class="checklist-note">
										<small>💡 Copy the folder link above and open in your Chrome, then click "New" → "Google Sheets"</small>
									</div>
								</div>
								
								<div class="checklist-section">
									<h5>💬 DISCORD</h5>
									<div class="checklist-item">
										<input type="checkbox" id="discord1" onchange="checkAllCompleted()" />
										<label for="discord1">Create channel "${result.discordChannelName}" in Discord server</label>
									</div>
								</div>
								
								<div class="checklist-section">
									<h5>🔗 IFTTT</h5>
									<div class="checklist-item">
										<input type="checkbox" id="ifttt0" onchange="checkAllCompleted()" />
										<label for="ifttt0">Reconnect Discord account to IFTTT</label>
									</div>
									<div class="checklist-item">
										<input type="checkbox" id="ifttt1" onchange="checkAllCompleted()" />
										<label for="ifttt1">Create "New ${result.envName} Tweets" applet in IFTTT</label>
									</div>
									<div class="checklist-item">
										<input type="checkbox" id="ifttt2" onchange="checkAllCompleted()" />
										<label for="ifttt2">Create "Relevant ${result.envName} Tweets" applet in IFTTT</label>
									</div>
									<div class="checklist-note">
										<small>💡 Go to ifttt.com/create to set up applets</small>
									</div>
								</div>
								
								<div class="warning-section">
									<div class="warning-box">
										<i class='bx bx-error-circle warning-icon'></i>
										<p><strong>⚠️ Warning:</strong> Incomplete setup leads to errors</p>
									</div>
									<div class="waiver-item">
										<input type="checkbox" id="waiver" onchange="checkAllCompleted()" />
										<label for="waiver">I memorize the steps and will be sure to do it. Enable finish button</label>
									</div>
								</div>
							</div>
						</div>
					`;
					
					// Add close button (initially disabled)
					document.querySelector('.modal-footer').innerHTML = `
						<button type="button" id="finishBtn" class="btn-primary" onclick="finishEnvironmentCreation()" disabled>Finish</button>
					`;
					
				} else {
					alert('Error creating environment: ' + result.message);
					// Reset form
					document.querySelector('.modal-body form').style.display = 'block';
					document.getElementById('automationProgress').style.display = 'none';
					document.querySelector('.btn-primary').style.display = 'inline-block';
				}
				
			} catch (error) {
				alert('Error creating environment: ' + error.message);
				// Reset form
				document.querySelector('.modal-body form').style.display = 'block';
				document.getElementById('automationProgress').style.display = 'none';
				document.querySelector('.btn-primary').style.display = 'inline-block';
			}
		}
		
		function copyFolderUrl() {
			const urlInput = document.getElementById('folderUrl');
			urlInput.select();
			urlInput.setSelectionRange(0, 99999); // For mobile devices
			
			try {
				document.execCommand('copy');
				const copyBtn = document.querySelector('.copy-btn');
				const originalText = copyBtn.innerHTML;
				copyBtn.innerHTML = '<i class="bx bx-check"></i> Copied!';
				copyBtn.style.background = '#28a745';
				
				setTimeout(() => {
					copyBtn.innerHTML = originalText;
					copyBtn.style.background = '';
				}, 2000);
			} catch (err) {
				alert('Failed to copy URL. Please copy manually.');
			}
		}
		
		function checkAllCompleted() {
			const taskCheckboxes = ['sheet1', 'sheet2', 'discord1', 'ifttt0', 'ifttt1', 'ifttt2'];
			const waiverCheckbox = document.getElementById('waiver');
			const finishBtn = document.getElementById('finishBtn');
			
			// Check if all task checkboxes are checked
			const allTasksChecked = taskCheckboxes.every(id => {
				const checkbox = document.getElementById(id);
				return checkbox && checkbox.checked;
			});
			
			// Check if waiver is checked
			const waiverChecked = waiverCheckbox && waiverCheckbox.checked;
			
			// Enable button if either:
			// 1. Waiver is checked (regardless of tasks), OR
			// 2. All tasks are checked (regardless of waiver)
			const shouldEnable = waiverChecked || allTasksChecked;
			
			if (finishBtn) {
				finishBtn.disabled = !shouldEnable;
				if (shouldEnable) {
					finishBtn.style.background = '#28a745';
					finishBtn.style.cursor = 'pointer';
				} else {
					finishBtn.style.background = '';
					finishBtn.style.cursor = 'not-allowed';
				}
			}
		}

		function updateProgressStep(stepId, status, message) {
			const step = document.getElementById(stepId);
			const icon = step.querySelector('i');
			const text = step.querySelector('span');
			
			step.className = `progress-step ${status}`;
			
			if (status === 'completed') {
				icon.className = 'bx bx-check';
			} else if (status === 'error') {
				icon.className = 'bx bx-x';
			}
			
			text.textContent = message;
		}
		
		function finishEnvironmentCreation() {
			closeAddEnvironmentModal();
			// Reload available topics to include the new environment
			loadAvailableTopics();
			// Show success message
			statusDiv.textContent = 'Environment created successfully! Please complete IFTTT setup manually.';
			statusDiv.className = 'status-message status-success';
			statusDiv.style.display = '';
		}

	</script>
</body>
</html>